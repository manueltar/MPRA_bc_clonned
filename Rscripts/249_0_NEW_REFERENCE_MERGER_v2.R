suppressMessages(library("plyr", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("data.table", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("crayon", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("withr", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("ggplot2", lib.loc = "/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("optparse", lib.loc = "/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("dplyr", lib.loc = "/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("withr", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("backports", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("broom", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("rstudioapi", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("reshape2", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("tzdb", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("cli", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("tidyverse", lib.loc="/nfs/team151/software/manuel_R_libs_4_1//"))
suppressMessages(library("BiocGenerics", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("S4Vectors", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("IRanges", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("GenomeInfoDb", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("GenomicRanges", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("Biobase", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("AnnotationDbi", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("GenomicFeatures", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("OrganismDbi", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("GO.db", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("org.Hs.eg.db", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("TxDb.Hsapiens.UCSC.hg19.knownGene", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("Homo.sapiens", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("gwascat", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("rtracklayer", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("plyr", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("data.table", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("crayon", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("withr", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("ggplot2", lib.loc = "/nfs/team151/software/manuel_R_libs_4_1/"))
library("farver", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/")
library("labeling", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/")
suppressMessages(library("optparse", lib.loc = "/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("dplyr", lib.loc = "/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("withr", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("backports", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("broom", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("rstudioapi", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("cli", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("tzdb", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("tidyverse", lib.loc="/nfs/team151/software/manuel_R_libs_4_1//"))
suppressMessages(library("BiocGenerics", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("S4Vectors", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("IRanges", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("GenomeInfoDb", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("GenomicRanges", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("Biobase", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("AnnotationDbi", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("GenomicFeatures", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("OrganismDbi", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
library("XVector", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/")
suppressMessages(library("Biostrings", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("seqinr", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("seqRFLP", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("splitstackshape", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
suppressMessages(library("vroom", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/"))
library("ape", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/")
library("phylotools", lib.loc="/nfs/team151/software/manuel_R_libs_4_1/")


opt = NULL

options(warn = 1)

wrangling = function(option_list)
{
 
  
  opt_in = option_list
  opt <<- option_list
  
  cat("All options:\n")
  printList(opt)
  
  
  #### READ and transform type ----
  
  type = opt$type
  
  cat("TYPE_\n")
  cat(sprintf(as.character(type)))
  cat("\n")
  
  
  #### READ and transform out ----
  
  out = opt$out
  
  cat("OUT_\n")
  cat(sprintf(as.character(out)))
  cat("\n")
  
  #### READ and transform LONG_MATRIX ----
  
  
  LONG_MATRIX = read.table(opt$LONG_MATRIX, sep="\t", stringsAsFactors = F, header = T)
  
  
  
  cat("----->LONG_MATRIX_PRE\n")
  cat(str(LONG_MATRIX))
  cat("\n")
  
  #### REFERENCE_1
  
  # fastaFile <- read.fasta(file=opt$REFERENCE_1)
  
  fastaFile <- readDNAStringSet(file=opt$REFERENCE_1)
  
  
  
  cat("REFERENCE_1_fastaFile\n")
  cat(str(fastaFile))
  cat("\n")
  
  seq_name = names(fastaFile)
  sequence = paste(fastaFile)
  
  
  REFERENCE_1 <- data.frame(seq_name, sequence, stringsAsFactors = F)
  
  #REFERENCE_1$seq_name<-gsub("^>","",REFERENCE_1$seq_name)
  
  cat("REFERENCE_1\n")
  cat(str(REFERENCE_1))
  cat("\n")
  
  #### REFERENCE_2
  
  # fastaFile <- read.fasta(file=opt$REFERENCE_2)
  
  fastaFile <- readDNAStringSet(file=opt$REFERENCE_2)
  
  
  
  cat("REFERENCE_2_fastaFile\n")
  cat(str(fastaFile))
  cat("\n")
  
  seq_name = names(fastaFile)
  sequence = paste(fastaFile)
  
  
  REFERENCE_2 <- data.frame(seq_name, sequence, stringsAsFactors = F)
  
  #REFERENCE_2$seq_name<-gsub("^>","",REFERENCE_2$seq_name)
  
  cat("REFERENCE_2\n")
  cat(str(REFERENCE_2))
  cat("\n")
  
  
  #### checks
  
  
  check_2_in_1<-REFERENCE_2[which(REFERENCE_2$seq_name%in%REFERENCE_1$seq_name),]
  
  cat("check_2_in_1\n")
  cat(str(check_2_in_1))
  cat("\n")
  
  check_2_EXCLUSIVE<-REFERENCE_2[-which(REFERENCE_2$seq_name%in%REFERENCE_1$seq_name),]
  
  cat("check_2_EXCLUSIVE\n")
  cat(str(check_2_EXCLUSIVE))
  cat("\n")
  
  check_1_in_2<-REFERENCE_1[which(REFERENCE_1$seq_name%in%REFERENCE_2$seq_name),]
  
  cat("check_1_in_2\n")
  cat(str(check_1_in_2))
  cat("\n")
  
  check_1_EXCLUSIVE<-REFERENCE_1[-which(REFERENCE_1$seq_name%in%REFERENCE_2$seq_name),]
  
  cat("check_1_EXCLUSIVE\n")
  cat(str(check_1_EXCLUSIVE))
  cat("\n")
  
    
 
  
  #### REFERENCE merge
  
  
  REFERENCE_DEF<-rbind(REFERENCE_2,check_1_EXCLUSIVE)
  
  
  # REFERENCE_DEF$seq_name<-paste('>',REFERENCE_DEF$seq_name,sep='')
  
  cat("REFERENCE_DEF_0\n")
  cat(str(REFERENCE_DEF))
  cat("\n")
  
 
  ##### REPRESENTATION -----
  
  check_1_EXCLUSIVE$REAL_TILE<-gsub("\\|.+$","",check_1_EXCLUSIVE$seq_name)
  
  
  cat("check_1_EXCLUSIVE_1\n")
  cat(str(check_1_EXCLUSIVE))
  cat("\n")
  
  LONG_MATRIX_represented<-LONG_MATRIX[which(LONG_MATRIX$REAL_TILE%in%check_1_EXCLUSIVE$REAL_TILE),]
  
  cat("LONG_MATRIX_represented_1\n")
  cat(str(LONG_MATRIX_represented))
  cat("\n")
  cat(sprintf(as.character(names(summary(as.factor(LONG_MATRIX_represented$factor4))))))
  cat("\n")
  cat(sprintf(as.character(summary(as.factor(LONG_MATRIX_represented$factor4)))))
  cat("\n")
  cat(sprintf(as.character(names(summary(as.factor(LONG_MATRIX_represented$Label))))))
  cat("\n")
  cat(sprintf(as.character(summary(as.factor(LONG_MATRIX_represented$Label)))))
  cat("\n")
  
  LONG_MATRIX_not_represented<-LONG_MATRIX[-which(LONG_MATRIX$REAL_TILE%in%check_1_EXCLUSIVE$REAL_TILE),]
  
  cat("LONG_MATRIX_not_represented_1\n")
  cat(str(LONG_MATRIX_not_represented))
  cat("\n")
  cat(sprintf(as.character(names(summary(as.factor(LONG_MATRIX_not_represented$factor4))))))
  cat("\n")
  cat(sprintf(as.character(summary(as.factor(LONG_MATRIX_not_represented$factor4)))))
  cat("\n")
  cat(sprintf(as.character(names(summary(as.factor(LONG_MATRIX_not_represented$Label))))))
  cat("\n")
  cat(sprintf(as.character(summary(as.factor(LONG_MATRIX_not_represented$Label)))))
  cat("\n")
  
  REFERENCE_2$REAL_TILE<-gsub("\\|.+$","",REFERENCE_2$seq_name)
  
  
  cat("REFERENCE_2_1\n")
  cat(str(REFERENCE_2))
  cat("\n")
  
  LONG_MATRIX_represented<-LONG_MATRIX[which(LONG_MATRIX$REAL_TILE%in%REFERENCE_2$REAL_TILE),]
  
  cat("LONG_MATRIX_represented_1\n")
  cat(str(LONG_MATRIX_represented))
  cat("\n")
  cat(sprintf(as.character(names(summary(as.factor(LONG_MATRIX_represented$factor4))))))
  cat("\n")
  cat(sprintf(as.character(summary(as.factor(LONG_MATRIX_represented$factor4)))))
  cat("\n")
  cat(sprintf(as.character(names(summary(as.factor(LONG_MATRIX_represented$Label))))))
  cat("\n")
  cat(sprintf(as.character(summary(as.factor(LONG_MATRIX_represented$Label)))))
  cat("\n")
  
  LONG_MATRIX_not_represented<-LONG_MATRIX[-which(LONG_MATRIX$REAL_TILE%in%REFERENCE_2$REAL_TILE),]
  
  cat("LONG_MATRIX_not_represented_1\n")
  cat(str(LONG_MATRIX_not_represented))
  cat("\n")
  cat(sprintf(as.character(names(summary(as.factor(LONG_MATRIX_not_represented$factor4))))))
  cat("\n")
  cat(sprintf(as.character(summary(as.factor(LONG_MATRIX_not_represented$factor4)))))
  cat("\n")
  cat(sprintf(as.character(names(summary(as.factor(LONG_MATRIX_not_represented$Label))))))
  cat("\n")
  cat(sprintf(as.character(summary(as.factor(LONG_MATRIX_not_represented$Label)))))
  cat("\n")
  
  REFERENCE_DEF$REAL_TILE<-gsub("\\|.+$","",REFERENCE_DEF$seq_name)
  
  
  cat("REFERENCE_DEF_1\n")
  cat(str(REFERENCE_DEF))
  cat("\n")
  
  LONG_MATRIX_represented<-LONG_MATRIX[which(LONG_MATRIX$REAL_TILE%in%REFERENCE_DEF$REAL_TILE),]
  
  cat("LONG_MATRIX_represented_1\n")
  cat(str(LONG_MATRIX_represented))
  cat("\n")
  cat(sprintf(as.character(names(summary(as.factor(LONG_MATRIX_represented$factor4))))))
  cat("\n")
  cat(sprintf(as.character(summary(as.factor(LONG_MATRIX_represented$factor4)))))
  cat("\n")
  cat(sprintf(as.character(names(summary(as.factor(LONG_MATRIX_represented$Label))))))
  cat("\n")
  cat(sprintf(as.character(summary(as.factor(LONG_MATRIX_represented$Label)))))
  cat("\n")
  
  LONG_MATRIX_not_represented<-LONG_MATRIX[-which(LONG_MATRIX$REAL_TILE%in%REFERENCE_DEF$REAL_TILE),]
  
  cat("LONG_MATRIX_not_represented_1\n")
  cat(str(LONG_MATRIX_not_represented))
  cat("\n")
  cat(sprintf(as.character(names(summary(as.factor(LONG_MATRIX_not_represented$factor4))))))
  cat("\n")
  cat(sprintf(as.character(summary(as.factor(LONG_MATRIX_not_represented$factor4)))))
  cat("\n")
  cat(sprintf(as.character(names(summary(as.factor(LONG_MATRIX_not_represented$Label))))))
  cat("\n")
  cat(sprintf(as.character(summary(as.factor(LONG_MATRIX_not_represented$Label)))))
  cat("\n")
  #### SAVE FASTA ----
  
  
  
  setwd(out)
  
  # fname <- tempfile(pattern = "GLOBAL_REFERENCE", tmpdir = tempdir(), fileext = "fasta")
  # 
  # # file.out<-paste('GLOBAL_REFERENCE','.fasta',sep='')
  # 
  # write.fasta(REFERENCE_DEF$sequence, REFERENCE_DEF$seq_name, file.out =fname, nbchar = 60)
  # 
  # writeLines(df.fasta, sep ="\n", paste('GLOBAL_REFERENCE','.fasta',sep=''))
  
  
  
  write.table(LONG_MATRIX_represented,file="NON_PROGRAMMED_LONG_matrix_seq_names_Plus_Flags_UPDATED_BY_REFERENCE.tsv",sep="\t",quote=F,row.names=F)
  
  
  # dat2fasta(REFERENCE_DEF, outfile = paste('GLOBAL_REFERENCE','.fasta',sep=''))
  
  
  
  indx.fasta<-c(which(colnames(REFERENCE_DEF) == "seq_name"),which(colnames(REFERENCE_DEF) == "sequence"))

  Merge2_TO_FASTA<-unique(REFERENCE_DEF[,indx.fasta])
  
  cat("Merge2_TO_FASTA_1\n")
  cat(str(Merge2_TO_FASTA))
  cat("\n")

  df.fasta = dataframe2fas(Merge2_TO_FASTA, file="df.fasta")
  
  cat("df.fasta_1\n")
  cat(str(df.fasta))
  cat("\n")

  # Here we print the fasta file

  writeLines(df.fasta, sep ="\n", paste('GLOBAL_REFERENCE','.fasta',sep=''))
  
  
}

# 
# ##############################################################################################################################################################################################################################
# quit(status = 1)  


printList = function(l, prefix = "    ") {
  list.df = data.frame(val_name = names(l), value = as.character(l))
  list_strs = apply(list.df, MARGIN = 1, FUN = function(x) { paste(x, collapse = " = ")})
  cat(paste(paste(paste0(prefix, list_strs), collapse = "\n"), "\n"))
}

#### main script ----

main = function() {
  cmd_line = commandArgs()
  cat("Command line:\n")
  cat(paste(gsub("--file=", "", cmd_line[4], fixed=T),
            paste(cmd_line[6:length(cmd_line)], collapse = " "),
            "\n\n"))
  option_list <- list(
    make_option(c("--LONG_MATRIX"), type="character", default=NULL,
                metavar="FILE.txt",
                help="Path to tab-separated input file listing regions to analyze. Required."),
    make_option(c("--REFERENCE_1"), type="character", default=NULL,
                metavar="FILE.txt",
                help="Path to tab-separated input file listing regions to analyze. Required."),
    make_option(c("--REFERENCE_2"), type="character", default=NULL,
                metavar="FILE.txt",
                help="Path to tab-separated input file listing regions to analyze. Required."),
    make_option(c("--type"), type="character", default=NULL, 
                metavar="type", 
                help="Path to tab-separated input file listing regions to analyze. Required."),
    make_option(c("--out"), type="character", default=NULL, 
                metavar="out", 
                help="Path to tab-separated input file listing regions to analyze. Required.")
  )
  parser = OptionParser(usage = "137_MPRA_normalization_and_filtering_Rscript_v2.R
                        --REAL_TILE_DF FILE.txt
                        --replicas charac
                        --type1 type1
                        --type2 type2
                        --barcodes_per_tile integer
                        --pvalThreshold integer
                        --FDRThreshold integer
                        --EquivalenceTable FILE.txt
                        --sharpr2Threshold charac",
                        option_list = option_list)
  opt <<- parse_args(parser)
  
  wrangling(opt)
 
  
}


###########################################################################

system.time( main() )
